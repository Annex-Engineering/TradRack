# Slicing

This document explains how to get your slicer set up for multimaterial
printing with Trad Rack. These instructions are mainly geared towards
PrusaSlicer and SuperSlicer, but some notes on custom gcode may be
applicable to other slicers too.

## Provided slicer profiles

Example slicer profiles are provided for PrusaSlicer and SuperSlicer.
These profiles are meant for use with a K3 running a Sherpa Micro
extruder and Mosquito Magnum hotend, but they can be modified to fit
other setups.

### Prerequisites

These profiles assume you have included
[trad_rack_optional.cfg](/Klipper_Stuff/klipper_config/trad_rack_optional.cfg)
in your Klipper config and that you have a `Print_Start` g-code macro
that takes the following parameters:

- `EXTRUDER`: Hotend temperature
- `BED`: Bed temperature

### Setup

See the [PrusaSlicer_Setup](PrusaSlicer_Setup.md) or 
[SuperSlicer_Setup document](SuperSlicer_Setup.md) for information on
adding the provided profiles to your slicer, as well as any setup tips
that pertain to that slicer specifically. In addition, if you are
using a different printer or toolhead setup, you may need to change
values in the "Single extruder multimaterial parameters" and
"Toolchange parameters with single extruder MM printers" sections in
the slicer. See
[changes to make to existing profiles](#changes-to-make-to-existing-profiles)
for more details on these settings.

### Experimental Options

Experimental profiles are included that eliminate the ramming and/or
unload gcode generated by the slicer in favor of using gcode or macros
called by the toolchange command: print profiles with "No Unload" and
filament profiles with "No Ramming" in their name. You must
select a printer profile with "Experimental" in its name to allow
these print and/or filament profiles to be selected.

In addition, if you use a "No Ramming" print profile, you must modify
`post_process` depending on where you have python installed and where
[remove_unload.py](/Slicer_Scripts/remove_unload.py) is located on
your computer. You can do this either in the slicer or by directly
editing the `Annex_K3_TR.ini` file in a text editor. If you choose to
edit `Annex_K3_TR.ini`, keep in mind that special characters such as
`"` and `\` must be escaped with a backslash. For example, here is the
setting I use, shown in the slicer:

![Plater: select profiles](images/ps_post-processing.png?raw=true)

And in the .ini file:

```ini
[print:*No Unload*]
post_process = "\"C:\\Users\\Ryan\\AppData\\Local\\Programs\\Python\\Python310\\python.exe\" \"C:\\Users\\Ryan\\Documents\\3d printing stuff\\TradRack_Beta\\Slicer_Scripts\\remove_unload.py\""
```

With the ramming and/or unload gcode removed, you will need to have
some sort of replacement run in the `pre_unload_gcode` in the
[trad_rack] section of your Klipper config. The simplest way to do
this (assuming you have included
[trad_rack_optional.cfg](/Klipper_Stuff/klipper_config/trad_rack_optional.cfg))
is to set `variable_shape_tip` to `True` in the
[gcode_macro TR_Variables] section. Keep in mind that the provided `Shape_Tip`
macro includes both ramming and unloading.

## Changes to make to existing profiles

This section explains changes to make to an existing single-tool
slicing profile. Setting names used here follow the "parameter names"
that are used in the slicer config files; you can use the search
function to see which settings these refer to in the GUI.

### Printer Settings

The following changes should be made to the printer config file in the
Printer Settings tab.

- `extruders_count`: Set this to the number of lanes.
- `single_extruder_multi_material`: Set to `true` (`1` in the config).
- `start_gcode`:
  - Add the following lines to the beginning of the Start G-code
    section:
    
    ```
    CLEAR_PAUSE
    TR_LOCATE_SELECTOR
    TR_Print_Start EXTRUDER={first_layer_temperature[initial_tool]} LANE=[initial_tool]
    ```
    
    Explanation:
    - `TR_LOCATE_SELECTOR`: See the 
      [G-Codes document](/docs/klipper/G-Codes.md/#tr_locate_selector)
      for more details
    - `TR_Print_Start`: Loads the first filament into the toolhead
  - Usually not required: if any g-code command or macro that gets
    called within your Start G-code section contains the `M18` or
    `M84` command, add the following to the end of
    the Start G-code section:
    
    ```
    TR_SET_ACTIVE_LANE LANE={initial_tool}
    ```

    Note: this includes commands that are called indirectly. For
    example, if the Start G-code section contains `Print_Start` and
    your `Print_Start` macro calls `G28`, and your config includes a
    \[homing_override\] section that causes `G28` to call `M18` or
    `M84`, this would still count.

    Explanation:
    - The `M18` or `M84` command disables all motors on the printer,
      include Trad Rack's motors. This will cause problems the next
      time Trad Rack tries to move its selector. Normally it is a bad
      idea to disable the motors inside your start g-code. However,
      it is sometimes used as a workaround in the \[homing_override\]
      section in order to allow the printer to move an axis without
      marking that axis as homed. For example, you may want to lift
      the z axis before homing x and y to ensure the nozzle does not
      scrape on the bed. If you do not want to remove `M18` or `M84`
      from the command or macro that is being called in your Start
      G-code section, the `TR_SET_ACTIVE_LANE` command can be used as
      shown above to force Trad Rack to set the selector's position
      without homing it again.
      
 - `retract_length_toolchange`: Set to `0` for all extruders.
 - `cooling_tube_retraction`: See the tooltip for details.
 - `cooling_tube_length`: See the tooltip for details.
 - `parking_pos_retract`: Set this to 
   `cooling_tube_retraction + cooling_tube_length / 2`.
 - `extra_loading_move`: Set this to a negative number with an
   absolute value slightly less than that of `parking_pos_retract`.
   For example, if `parking_pos_retract` is `37`, set this to
   `-36.99`.
 - Advanced wipe tower purge volume calculs:
   - In SuperSlicer, one of the options for purge volume calculations
     is to have the slicer calculate volumes based on each filament's
     pigment percentage. See the tooltips for more details on these
     settings:
     - `wipe_advanced`
     - `wipe_advanced_nozzle_melted_volume`
     - `wipe_advanced_multiplier`
     - `wipe_advanced_algo`

### Print Settings

The following changes should be made to the print config file in the
Print Settings tab.

- `wipe_tower`: set to `true` (`1` in the config) unless you are using
  an alternative way of purging material.
- `only_retract_when_crossing_perimeters`: set to `false` (`0` in the
  config) to avoid colors bleeding into each other when the nozzle
  moves over the print.
- `gcode_substitutions`:
  - PrusaSlicer:
    - in the config file:

      ```ini
      gcode_substitutions = "(SET_PRESSURE_ADVANCE ADVANCE=[0.]+)\\n";"Save_Pressure_Advance\\n${1}\\n";r;"Save PA before ramming"
      ```

    - or in the GUI:
      
      ![PrusaSlicer gcode_substitutions](images/ps_gcode_substitutions.png?raw=true)

      - Find: `(SET_PRESSURE_ADVANCE ADVANCE=[0.]+)\n`
      - Replace with: `Save_Pressure_Advance\n${1}\n`
      - Notes: `Save PA before ramming`
      - Make sure "Regular expression" is checked!    

  - SuperSlicer:
    - in the config file:

      ```ini
      gcode_substitutions = "(SET_PRESSURE_ADVANCE ADVANCE=[0.]+)(?: EXTRUDER=extruder[0-9]*)?\\n";"Save_Pressure_Advance\\n${1}\\n";r;"See: https://github.com/supermerill/SuperSlicer/issues/2934 (3073 too)"
      ```

    - or in the GUI:

      ![SuperSlicer gcode_substitutions](images/ss_gcode_substitutions.png?raw=true)

      - Find: `(SET_PRESSURE_ADVANCE ADVANCE=[0.]+)(?: EXTRUDER=extruder[0-9]*)?\n`
      - Replace with: `Save_Pressure_Advance\n${1}\n`
      - Notes: `See: https://github.com/supermerill/SuperSlicer/issues/2934 (3073 too)`
      - Make sure "Regular expression" is checked!

### Filament Settings

The following changes should be made to each filament config file in
the Filament Settings tab.

(this section is not done yet; everything you might need to change
that is specific to multimaterial or Trad Rack should be located
in Multimaterial > Toolchange parameters with single extruder MM
printers. I recommend looking at the provided example config files.)
