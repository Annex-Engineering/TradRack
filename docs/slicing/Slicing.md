# Slicing

This document explains how to get your slicer set up for multimaterial
printing with Trad Rack. These instructions are mainly geared towards
PrusaSlicer and SuperSlicer, but some notes on custom gcode may be
applicable to other slicers too.

## Provided slicer profiles

Example slicer profiles are provided for PrusaSlicer and SuperSlicer.
These profiles are meant for use with a K3 running a Sherpa Micro
extruder and Mosquito Magnum hotend, but they can be modified to fit
other setups.

### Prerequisites

These profiles assume you have included
[trad_rack_optional.cfg](/Klipper_Stuff/klipper_config/trad_rack_optional.cfg)
in your Klipper config and that you have a `Print_Start` g-code macro
that takes the following parameters:

- `EXTRUDER`: Hotend temperature
- `BED`: Bed temperature

### Setup

See the [PrusaSlicer_Setup](PrusaSlicer_Setup.md) or 
[SuperSlicer_Setup document](SuperSlicer_Setup.md) for information on
adding the provided profiles to your slicer, as well as any setup tips
that pertain to that slicer specifically. In addition, if you are
using a different printer or toolhead setup, you may need to change
values in the "Single extruder multimaterial parameters" and
"Toolchange parameters with single extruder MM printers" sections in
the slicer. See
[changes to make to existing profiles](#changes-to-make-to-existing-profiles)
for more details on these settings.


Example slicer profiles for SuperSlicer can be found in the
[Slicer_Config folder](/Slicer_Config/). To use these profiles, copy
the files into the corresponding `filament`, `print`, and `printer`
folders located in:

- Windows: `C:\users\<username>\AppData\Roaming\SuperSlicer`
- Mac: `/Users/<username>/Library/Application Support/SuperSlicer`



Note: the purge volumes used in these profiles are for a mosquito
magnum, but I have not done much experimentation or optimization.
I would recommend doing your own tuning on purge volumes, try
different wipe advanced algorithms (or use the purge volume tables),
etc.

### Experimental Options

Experimental profiles are included that eliminate the ramming and/or
unload gcode generated by the slicer in favor of using gcode or macros
called by the toolchange command: print profiles with "No Unload" and
filament profiles with "No Ramming" in their name. You must
select a printer profile with "Experimental" in its name to allow
these print and/or filament profiles to be selected.

In addition, if you use a "No Ramming" print profile, you must modify
`post_process` depending on where you have python installed and where
[remove_unload.py](/Slicer_Scripts/remove_unload.py) is located on
your computer. You can do this either in the slicer or by directly
editing the `Annex_K3_TR.ini` file in a text editor. If you choose to
edit `Annex_K3_TR.ini`, keep in mind that special characters such as
`"` and `\` must be escaped with a backslash. For example, here is the
setting I use, shown in the slicer:

![Plater: select profiles](images/ps_post-processing.png?raw=true)

And in the .ini file:

```ini
[print:*No Unload*]
post_process = "\"C:\\Users\\Ryan\\AppData\\Local\\Programs\\Python\\Python310\\python.exe\" \"C:\\Users\\Ryan\\Documents\\3d printing stuff\\TradRack_Beta\\Slicer_Scripts\\remove_unload.py\""
```

With the ramming and/or unload gcode removed, you will need to have
some sort of replacement run in the `pre_unload_gcode` in the
[trad_rack] section of your Klipper config. The simplest way to do
this (assuming you have included
[trad_rack_optional.cfg](/Klipper_Stuff/klipper_config/trad_rack_optional.cfg))
is to set `variable_shape_tip` to `True` in the
[gcode_macro TR_Variables] section. Keep in mind that the provided `Shape_Tip`
macro includes both ramming and unloading.

## Changes to make to existing profiles

This section explains changes to make to an existing single-tool
slicing profile. Setting names used here follow the "parameter names"
that are used in the slicer config files; you can use the search
function to see which settings these refer to in the GUI.

### Printer Settings

The following changes should be made to the printer config file in the
Printer Settings tab.

- `extruders_count`: Set this to the number of lanes.
- `single_extruder_multi_material`: Set to `true` (`1` in the config).
- `start_gcode`:
  - Add the following lines to the beginning of the Start G-code
    section:
    
    ```
    CLEAR_PAUSE
    TR_LOCATE_SELECTOR
    TR_Print_Start EXTRUDER=[first_layer_temperature] LANE=[initial_tool]
    ```
    
    Explanation:
    - `TR_LOCATE_SELECTOR`: See the 
      [G-Codes document](/docs/klipper/G-Codes.md/#tr_locate_selector)
      for more details
    - `TR_Print_Start`: Loads the first filament into the toolhead
 - `cooling_tube_retraction`: See the tooltip for details.
 - `cooling_tube_length`: See the tooltip for details.
 - `parking_pos_retract`: Set this to 
   `cooling_tube_retraction + cooling_tube_length / 2`.
 - `extra_loading_move`: Set this to a negative number with an
   absolute value slightly less than that of `parking_pos_retract`.
   For example, if `parking_pos_retract` is `37`, set this to
   `-36.99`.
 - Advanced wipe tower purge volume calculs:
   - In SuperSlicer, one of the options for purge volume calculations
     is to have the slicer calculate volumes based on each filament's
     pigment percentage. See the tooltips for more details on these
     settings:
     - `wipe_advanced`
     - `wipe_advanced_nozzle_melted_volume`
     - `wipe_advanced_multiplier`
     - `wipe_advanced_algo`

### Print Settings

The following changes should be made to the print config file in the
Print Settings tab.

- `wipe_tower`: set to `true` (`1` in the config) unless you are using
  an alternative way of purging material.
- `only_retract_when_crossing_perimeters`: set to `false` (`0` in the
  config) to avoid colors bleeding into each other when the nozzle
  moves over the print.
- `gcode_substitutions`:
  - PrusaSlicer:
    ```ini
    gcode_substitutions = "(SET_PRESSURE_ADVANCE ADVANCE=[0.]+)\\n";"Save_Pressure_Advance\\n${1}\\n";r;"Save PA before ramming"
    ```
  - SuperSlicer:
    ```ini
    gcode_substitutions = "(SET_PRESSURE_ADVANCE ADVANCE=[0.]+)(?: EXTRUDER=extruder[0-9]*)?\\n";"Save_Pressure_Advance\\n${1}\\n";r;"See: https://github.com/supermerill/SuperSlicer/issues/2934 (3073 too)"
    ```

### Filament Settings

The following changes should be made to each filament config file in
the Filament Settings tab.

(this section is not done yet; everything you might need to change
that is specific to multimaterial or Trad Rack should be located
in Multimaterial > Toolchange parameters with single extruder MM
printers. I recommend looking at the provided example config files.)
